<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" >
    <title>Paint COVID-19</title>
<style>
    html {
        margin:0px;
    }
    body {
        margin:0px;
        padding:1em;
        font-family: 'Roboto', sans-serif;
        font-weight: 300;
    }
</style>
<body>
    <h1>Paint COVID-19</h1>
    <div id="shared">
        <p>COVID-19 gene sequence consists of 29903 gene "letters" (ATCG). 
            Here you can assign each letter a color and paint the virus code 
            as an image. You can even send the virus to a friend of foe.</p>
        <p>
            A:<input type="color" id='a' value='#00ffff' onchange="paintIt()"> <!--aqua-->
            T:<input type="color" id='t' value='#008080' onchange="paintIt()"> <!--teal-->
            C:<input type="color" id='c' value='#DC143C' onchange="paintIt()"> <!--crimson-->
            G:<input type="color" id='g' value='#00ff00'  onchange="paintIt()"> <!--green-->
            <!--Pixel size: <input type="number" value="2" id="pixelsize" style="width:3em" onchange="paintIt()">    -->
        </p>
        <p>
            Message:<br>
            <textarea cols="60" rows="6" id="m" onchange="paintIt()">Type a message to be shared with a friend.</textarea>
        </p>    
    </div>
    <p id="msg"></p>
    <p>
        <canvas width=172 height=172></canvas>
    </p>
    <p>
        <small>Sequence source <a href="https://www.ncbi.nlm.nih.gov/nuccore/MN908947">https://www.ncbi.nlm.nih.gov/nuccore/MN908947</a></small>
    </p>
    <script src="sequence.js"></script>
    <script>
window.addEventListener("load",()=>{
    paintIt(true)
})    

function getParams(){
    const ret = {}
    if (window.location.search){
        ret.a=getQueryVariable("a")
        ret.t=getQueryVariable("t")
        ret.c=getQueryVariable("c")
        ret.g=getQueryVariable("g")
        ret.m=getQueryVariable("m")
        ret.s=getQueryVariable("s")
    }
    return ret;
}

function params2inputs(params){
    console.log("params2inputs")
    if (params.a) document.querySelector('#a').value=params.a
    if (params.c) document.querySelector('#c').value=params.c
    if (params.t) document.querySelector('#t').value=params.t
    if (params.g) document.querySelector('#g').value=params.g
    if (params.m) document.querySelector('#m').value=params.m //msg
    if (params.s) document.querySelector('#s').value=params.s //sharing
}

function getInputs(){
    const ret = {}
    ret.a=document.querySelector('#a').value=ret.a
    ret.c=document.querySelector('#c').value=ret.c
    ret.t=document.querySelector('#t').value=ret.t
    ret.g=document.querySelector('#g').value=ret.g
    ret.m=document.querySelector('#m').value=ret.m //msg
    //ret.s=document.querySelector('#s').value=ret.s //sharing
    return ret;
}

function paintIt(load){
    let params;
    console.log(`load: ${load}`)
    if (load){
        console.log("Load")
        params = {
            ...getInputs(),
            ...getParams()
        }
        params2inputs(params)
    } else {
        //change
        console.log("Change")
        params = getInputs()
        window.history.replaceState(null,null,`${window.location.origin}?a=${params.a}&c=${encodeURIComponent(params.c)}&t=${encodeURIComponent(params.t)}&g=${encodeURIComponent(params.g)}&m=${encodeURIComponent(params.m)}`)
    }
    console.log(params)
    const canvas = document.querySelector("canvas")
    const ctx = canvas.getContext('2d')
    //const pixelSize=document.querySelector("#pixelsize").value || 3 //letter width
    const pixelSize=2
    const imgW=Math.floor(Math.sqrt(seq.length))
    console.log(`imgW: ${imgW}`)
    canvas.width=imgW*pixelSize
    canvas.height=imgW*pixelSize
    
    let y=0;
    let x=0;
    for (let i=0; i<seq.length; i++){
        ctx.fillStyle=params[seq[i]]
        ctx.fillRect(x*pixelSize,y*pixelSize,pixelSize,pixelSize)
        x = (x+1) % imgW
        y = Math.floor(i / imgW)
    }   
    ctx.globalAlpha=0.50
    ctx.fillStyle="black"
    ctx.textAlign="right"
    ctx.font=`bold ${imgW/4}px sans-serif`
    ctx.fillText("COVID-19",imgW*pixelSize-2*pixelSize,imgW*pixelSize-2*pixelSize, imgW*pixelSize-4)


}

function getQueryVariable(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
        }
    }
    console.log('Query variable %s not found', variable);
}
    </script>
</body>
</html>